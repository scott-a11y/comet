// Comet Shop Layout Tool - Complete Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ShopBuilding {
  id                  Int              @id @default(autoincrement())
  userId              String?          @map("user_id")
  name                String
  widthFt             Float?           @map("width_ft")
  depthFt             Float?           @map("depth_ft")
  ceilingHeightFt     Float?           @map("ceiling_height_ft")
  hasMezzanine        Boolean          @default(false) @map("has_mezzanine")
  notes               String?          @db.Text
  pdfUrl              String?          @map("pdf_url")
  extractedData       Json?            @map("extracted_data")
  // Manual-drawn floor geometry (2D) stored as JSON for flexibility.
  // See lib/types/building-geometry.ts
  floorGeometry       Json?            @map("floor_geometry")
  // Calibration: feet per canvas unit (Konva world unit)
  floorScaleFtPerUnit Float?           @map("floor_scale_ft_per_unit")
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")
  zones               ShopZone[]
  utilityPoints       UtilityPoint[]
  equipment           Equipment[]
  layouts             LayoutInstance[]
  designerLayouts     Layout[]
  entryPoints         EntryPoint[]

  @@index([name])
  @@index([createdAt])
  @@map("shop_buildings")
}

model ShopZone {
  id             Int          @id @default(autoincrement())
  shopBuildingId Int          @map("shop_building_id")
  name           String
  x              Float
  y              Float
  width          Float
  height         Float
  zoneType       String       @map("zone_type")
  shopBuilding   ShopBuilding @relation(fields: [shopBuildingId], references: [id], onDelete: Cascade)
  equipment      Equipment[]

  @@index([shopBuildingId])
  @@map("shop_zones")
}

model UtilityPoint {
  id             Int                 @id @default(autoincrement())
  shopBuildingId Int                 @map("shop_building_id")
  type           String
  name           String
  x              Float
  y              Float
  voltage        Float?
  phase          Int?
  amps           Float?
  kva            Float?
  isMainService  Boolean             @default(false) @map("is_main_service")
  isOutdoor      Boolean             @default(false) @map("is_outdoor")
  shopBuilding   ShopBuilding        @relation(fields: [shopBuildingId], references: [id], onDelete: Cascade)
  dustRunsFrom   DustRun[]           @relation("DustRunFromUtility")
  dustRunsTo     DustRun[]           @relation("DustRunToUtility")
  airRunsFrom    AirRun[]            @relation("AirRunFromUtility")
  circuits       ElectricalCircuit[] @relation("CircuitPanel")

  @@index([shopBuildingId])
  @@index([type])
  @@map("utility_points")
}

model Equipment {
  id                  Int                       @id @default(autoincrement())
  shopBuildingId      Int                       @map("shop_building_id")
  name                String
  category            String
  widthFt             Float                     @map("width_ft")
  depthFt             Float                     @map("depth_ft")
  orientation         Float                     @default(0)
  requiresDust        Boolean                   @default(false) @map("requires_dust")
  requiresAir         Boolean                   @default(false) @map("requires_air")
  requiresHighVoltage Boolean                   @default(false) @map("requires_high_voltage")
  preferredZoneId     Int?                      @map("preferred_zone_id")
  shopBuilding        ShopBuilding              @relation(fields: [shopBuildingId], references: [id], onDelete: Cascade)
  preferredZone       ShopZone?                 @relation(fields: [preferredZoneId], references: [id], onDelete: SetNull)
  powerSpecs          EquipmentPowerSpecs?
  dustSpecs           EquipmentDustSpecs?
  airSpecs            EquipmentAirSpecs?
  layoutPositions     EquipmentLayoutPosition[]
  dustRunsFrom        DustRun[]                 @relation("DustRunFromEquipment")
  dustRunsTo          DustRun[]                 @relation("DustRunToEquipment")
  airRuns             AirRun[]
  circuits            EquipmentCircuit[]

  @@index([shopBuildingId])
  @@index([preferredZoneId])
  @@index([name])
  @@index([category])
  @@map("equipment")
}

model EquipmentPowerSpecs {
  equipmentId Int       @id @map("equipment_id")
  voltage     Float
  phase       Int
  amps        Float
  powerKw     Float?    @map("power_kw")
  circuitType String    @default("standard") @map("circuit_type")
  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@map("equipment_power_specs")
}

model EquipmentDustSpecs {
  id             Int       @id @default(autoincrement())
  equipmentId    Int       @unique @map("equipment_id")
  numPorts       Int       @default(1) @map("num_ports")
  portDiameterIn Float     @map("port_diameter_in")
  cfmRequirement Float?    @map("cfm_requirement")
  equipment      Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@map("equipment_dust_specs")
}

model EquipmentAirSpecs {
  id          Int       @id @default(autoincrement())
  equipmentId Int       @unique @map("equipment_id")
  pressureBar Float     @map("pressure_bar")
  flowScfm    Float?    @map("flow_scfm")
  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@map("equipment_air_specs")
}

model LayoutInstance {
  id                 Int                       @id @default(autoincrement())
  shopBuildingId     Int                       @map("shop_building_id")
  name               String
  createdAt          DateTime                  @default(now()) @map("created_at")
  updatedAt          DateTime                  @updatedAt @map("updated_at")
  
  // Collision tracking
  hasCollisions      Boolean                   @default(false) @map("has_collisions")
  collisionCount     Int                       @default(0) @map("collision_count")
  collisionData      Json?                     @map("collision_data")
  lastCollisionCheck DateTime?                 @map("last_collision_check")
  
  shopBuilding       ShopBuilding              @relation(fields: [shopBuildingId], references: [id], onDelete: Cascade)
  equipmentPositions EquipmentLayoutPosition[]
  dustRuns           DustRun[]
  airRuns            AirRun[]
  circuits           ElectricalCircuit[]
  systemRuns         SystemRun[]
  materialFlowPaths  MaterialFlowPath[]

  @@index([shopBuildingId])
  @@index([createdAt])
  @@index([hasCollisions])
  @@map("layout_instances")
}

// Unified system run model for auto-generated systems
model SystemRun {
  id              Int            @id @default(autoincrement())
  layoutId        Int            @map("layout_id")
  systemType      String         @map("system_type") // 'DUST' | 'AIR' | 'ELECTRICAL'
  fromEquipmentId Int?           @map("from_equipment_id")
  toUtilityId     Int?           @map("to_utility_id")
  pathData        Json           @map("path_data") // Array of {x, y} points
  diameter        Float?         // For DUST and AIR systems (inches)
  wireSize        String?        @map("wire_size") // For ELECTRICAL systems
  calculations    Json           // Store all calculation results
  metadata        Json?          // Additional metadata
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  
  layout          LayoutInstance @relation(fields: [layoutId], references: [id], onDelete: Cascade)
  
  @@index([layoutId])
  @@index([systemType])
  @@map("system_runs")
}

model EquipmentLayoutPosition {
  id          Int            @id @default(autoincrement())
  layoutId    Int            @map("layout_id")
  equipmentId Int            @map("equipment_id")
  x           Float
  y           Float
  orientation Float          @default(0)
  locked      Boolean        @default(false)
  layout      LayoutInstance @relation(fields: [layoutId], references: [id], onDelete: Cascade)
  equipment   Equipment      @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([layoutId, equipmentId])
  @@index([equipmentId])
  @@map("equipment_layout_positions")
}

model DustRun {
  id                 Int            @id @default(autoincrement())
  layoutId           Int            @map("layout_id")
  fromEquipmentId    Int?           @map("from_equipment_id")
  toEquipmentId      Int?           @map("to_equipment_id")
  fromUtilityId      Int?           @map("from_utility_id")
  toUtilityId        Int?           @map("to_utility_id")
  diameterIn         Float          @map("diameter_in")
  lengthFt           Float          @map("length_ft")
  
  // Flow calculations
  cfm                Float?         @default(0)
  velocityFpm        Float?         @map("velocity_fpm")
  staticPressureLoss Float?         @map("static_pressure_loss_in_wg")

  layout             LayoutInstance @relation(fields: [layoutId], references: [id], onDelete: Cascade)
  fromEquipment      Equipment?     @relation("DustRunFromEquipment", fields: [fromEquipmentId], references: [id], onDelete: SetNull)
  toEquipment        Equipment?     @relation("DustRunToEquipment", fields: [toEquipmentId], references: [id], onDelete: SetNull)
  fromUtility        UtilityPoint?  @relation("DustRunFromUtility", fields: [fromUtilityId], references: [id], onDelete: SetNull)
  toUtility          UtilityPoint?  @relation("DustRunToUtility", fields: [toUtilityId], references: [id], onDelete: SetNull)

  @@index([layoutId])
  @@map("dust_runs")
}

model AirRun {
  id             Int            @id @default(autoincrement())
  layoutId       Int            @map("layout_id")
  fromUtilityId  Int            @map("from_utility_id")
  toEquipmentId  Int?           @map("to_equipment_id")
  pipeDiameterIn Float          @map("pipe_diameter_in")
  lengthFt       Float          @map("length_ft")
  layout         LayoutInstance @relation(fields: [layoutId], references: [id], onDelete: Cascade)
  fromUtility    UtilityPoint   @relation("AirRunFromUtility", fields: [fromUtilityId], references: [id])
  toEquipment    Equipment?     @relation(fields: [toEquipmentId], references: [id], onDelete: SetNull)

  @@index([layoutId])
  @@map("air_runs")
}

model ElectricalCircuit {
  id                Int                @id @default(autoincrement())
  layoutId          Int                @map("layout_id")
  panelUtilityId    Int                @map("panel_utility_id")
  circuitNumber     String             @map("circuit_number")
  voltage           Float
  phase             Int
  breakerAmps       Float              @map("breaker_amps")
  wireGauge         String?            @map("wire_gauge")
  notes             String?            @db.Text
  layout            LayoutInstance     @relation(fields: [layoutId], references: [id], onDelete: Cascade)
  panel             UtilityPoint       @relation("CircuitPanel", fields: [panelUtilityId], references: [id])
  equipmentCircuits EquipmentCircuit[]

  @@index([layoutId])
  @@index([panelUtilityId])
  @@map("electrical_circuits")
}

model EquipmentCircuit {
  id          Int               @id @default(autoincrement())
  circuitId   Int               @map("circuit_id")
  equipmentId Int               @map("equipment_id")
  distanceFt  Float?            @map("distance_ft")
  circuit     ElectricalCircuit @relation(fields: [circuitId], references: [id], onDelete: Cascade)
  equipment   Equipment         @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([circuitId, equipmentId])
  @@map("equipment_circuits")
}

// Layout models for shop designer
model Layout {
  id          String  @id @default(cuid())
  name        String
  description String?

  // The building this layout belongs to
  buildingId Int
  building   ShopBuilding @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  // JSON storage for the canvas state (positions, rotation, etc.)
  // We use JSONB for flexibility in the drag-and-drop UI
  canvasState Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation to equipment instances used in this layout
  equipmentInstances EquipmentInstance[]

  @@index([buildingId])
}

// Specific instances of equipment placed on a layout
model EquipmentInstance {
  id       String @id @default(cuid())
  layoutId String
  layout   Layout @relation(fields: [layoutId], references: [id], onDelete: Cascade)

  // Reference to a catalog item (future feature)
  // catalogItemId String?

  name String // e.g., "Table Saw 1"
  type String // e.g., "SAW", "DUST_COLLECTOR"

  // Physical properties override
  width  Float
  length Float

  // Position data (Cached here for querying, detailed visual data in canvasState)
  x        Float @default(0)
  y        Float @default(0)
  rotation Float @default(0)


  // AI-extracted specifications
  specs    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([layoutId])
}

// SOP (Standard Operating Procedures) Management
model SOP {
  id          String    @id @default(cuid())
  title       String
  category    String    // e.g., "Safety", "Quality", "Maintenance"
  version     String    @default("1.0")
  status      String    @default("draft") // draft, active, archived
  description String?   @db.Text
  tags        String[]  @default([])
  
  // Metadata
  createdBy   String?
  approvedBy  String?
  approvedAt  DateTime?
  
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  steps       SOPStep[]
  
  @@index([category])
  @@index([status])
  @@index([createdAt])
  @@map("sops")
}

model SOPStep {
  id              String   @id @default(cuid())
  sopId           String   @map("sop_id")
  stepNumber      Int      @map("step_number")
  title           String
  instructions    String   @db.Text
  photoUrl        String?  @map("photo_url")
  estimatedMinutes Float?  @map("estimated_minutes")
  safetyNotes     String?  @db.Text @map("safety_notes")
  
  sop             SOP      @relation(fields: [sopId], references: [id], onDelete: Cascade)
  
  @@unique([sopId, stepNumber])
  @@index([sopId])
  @@map("sop_steps")
}

// Quality Tracking System
model DefectLog {
  id              String   @id @default(cuid())
  defectType      String   @map("defect_type")
  severity        String   // low, medium, high, critical
  description     String   @db.Text
  location        String?
  productLine     String?  @map("product_line")
  
  // Root cause analysis
  rootCause       String?  @db.Text @map("root_cause")
  correctiveAction String? @db.Text @map("corrective_action")
  
  // Status tracking
  status          String   @default("open") // open, investigating, resolved, closed
  resolvedAt      DateTime? @map("resolved_at")
  
  // Metadata
  reportedBy      String?  @map("reported_by")
  assignedTo      String?  @map("assigned_to")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@index([defectType])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
  @@map("defect_logs")
}

// Entry Points (Doors, Loading Docks, etc.)
model EntryPoint {
  id             Int          @id @default(autoincrement())
  shopBuildingId Int          @map("shop_building_id")
  name           String
  type           String       // 'door', 'loading_dock', 'overhead_door', 'emergency_exit'
  x              Float
  y              Float
  widthFt        Float        @default(3) @map("width_ft")
  direction      String?      // 'north', 'south', 'east', 'west'
  isPrimary      Boolean      @default(false) @map("is_primary")
  notes          String?      @db.Text
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  
  shopBuilding   ShopBuilding @relation(fields: [shopBuildingId], references: [id], onDelete: Cascade)
  flowPathsFrom  MaterialFlowPath[] @relation("FlowPathFrom")
  flowPathsTo    MaterialFlowPath[] @relation("FlowPathTo")
  
  @@index([shopBuildingId])
  @@index([type])
  @@map("entry_points")
}

// Material Flow Paths
model MaterialFlowPath {
  id               Int            @id @default(autoincrement())
  layoutId         Int            @map("layout_id")
  name             String
  fromEntryPointId Int?           @map("from_entry_point_id")
  toEntryPointId   Int?           @map("to_entry_point_id")
  pathType         String         // 'receiving', 'processing', 'shipping', 'waste'
  pathData         Json           @map("path_data") // Array of {x, y} points
  color            String         @default("#3b82f6")
  notes            String?        @db.Text
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  
  layout           LayoutInstance @relation(fields: [layoutId], references: [id], onDelete: Cascade)
  fromEntryPoint   EntryPoint?    @relation("FlowPathFrom", fields: [fromEntryPointId], references: [id], onDelete: SetNull)
  toEntryPoint     EntryPoint?    @relation("FlowPathTo", fields: [toEntryPointId], references: [id], onDelete: SetNull)
  
  @@index([layoutId])
  @@index([pathType])
  @@map("material_flow_paths")
}

